<!DOCTYPE html>
<html lang="en">
    <head>
        <style>
            table, td, th {  
              border: 1px solid #ddd;
              text-align: left;
            }
            
            table {
              border-collapse: collapse;
              width: 100%;
              margin-bottom: 4px;
            }
            
            th, td {
              padding: 15px;
            }
            .D_style{
                margin-top: 4%;
                margin-bottom: 4%;
            }
            </style>
        <title>JavaScript - read JSON from URL</title>
            <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
            <!-- html2canvas library -->
            <script src="js/html2canvas.min.js"></script>

            <!-- jsPDF library -->
            <script src="js/jsPDF/dist/jspdf.min.js"></script>
        </head>
<body>
    <h2 class="month" >สรุปการใช้งานเครื่องยืมร่มประจำเดือน </h2>
    <!-- <button type="button" onclick="myFunction()">Click Me!</button> -->
    <button onclick="Convert_HTML_To_PDF();">Convert HTML to PDF</button>
    <div class="D_style">
        <h4>จำนวนการใช้บริการยืมร่ม ทั้งหมด  <b class="demo"></b> ครั้ง</h4>
        <Script>
                            $.getJSON('https://umbrellashareserver.herokuapp.com/month', function(data) {
                    $('.demo').append(data.length);
                });
        </Script>
        <table class="table1" style="border-collapse: collapse;">
            <tr>
                <th>ลำดับ</th>
                <th>รหัสผู้ยืม</th>
                <th>รหัสร่ม</th>
                <th>สถานที่ยืม</th>
                <th>วันที่ยืม</th>
                <th>สถานที่คืน</th>
                <th>วันที่คืน</th>
            </tr>
            <script>
                $.getJSON('https://umbrellashareserver.herokuapp.com/month', function(data) {
                    const thai_month = ['มกราคม','กุมภาพันธุ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฏาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
                    const b_m = new Date(parseInt(data[1].borrow_time));
                    const currentMonth = b_m.getMonth(); 
                    $('.month').append(thai_month[currentMonth]);

                    var tr = data.report
                    for (var i = 0; i < data.length; i++) {
                        const b_day = new Date(parseInt(data[i].borrow_time));
                        b_day.toDateString();
                        const g_day = new Date(parseInt(data[i].getting_time));
                        g_day.toDateString();
                        tr = $('<tr/>');
                        tr.append("<td>"+(i+1)+"</td>");
                        tr.append("<td>"+data[i].user_id+"</td>");
                        tr.append("<td>"+data[i].umbrella_id+"</td>");
                        tr.append("<td>"+data[i].borrow_place+"</td>");
                        tr.append("<td>"+b_day.toLocaleDateString()+"</td>");
                        tr.append("<td>"+data[i].getting_place+"</td>");
                        tr.append("<td>"+g_day.toLocaleDateString()+"</td>");
                        $('.table1').append(tr);
                    }
                });
            </script>
        </table>
    </div>
    <div class="D_style">
        <h4>จำนวนร่มที่ถูกยืมอยู่ ทั้งหมด  <b class="demo2"></b> คัน</h4>
        <Script>
                            $.getJSON('https://umbrellashareserver.herokuapp.com/month_borrowing', function(data) {
                    $('.demo2').append(data.length);
                });
        </Script>
        <table class="table2" style="border-collapse: collapse;">
            <tr>
                <th>ลำดับ</th>
                <th>รหัสผู้ยืม</th>
                <th>รหัสร่ม</th>
                <th>สถานที่ยืม</th>
                <th>วันที่ยืม</th>
                <th>วันกำหนดคืน</th>
            </tr>
            <script>
                $.getJSON('https://umbrellashareserver.herokuapp.com/month_borrowing', function(data) {
                    var tr = data.report
                    for (var i = 0; i < data.length; i++) {
                        const b_day = new Date(parseInt(data[i].borrow_time));
                        b_day.toDateString();
                        const exp_day = new Date(parseInt(data[i].borrow_time));
                        exp_day.setDate(exp_day.getDate()+3);
                        // expired_date.toDateString();
                        tr = $('<tr/>');
                        tr.append("<td>"+(i+1)+"</td>");
                        tr.append("<td>"+data[i].user_id+"</td>");
                        tr.append("<td>"+data[i].umbrella_id+"</td>");
                        tr.append("<td>"+data[i].borrow_place+"</td>");
                        tr.append("<td>"+b_day.toLocaleDateString()+"</td>");
                        tr.append("<td>"+exp_day.toLocaleDateString()+"</td>");
                        $('.table2').append(tr);
                    }
                });
            </script>
        </table>
    </div>
    <div class="D_style">
        <h4>จำนวนร่มที่ยืมเกินกำหนด ทั้งหมด  <b class="demo3"></b> คัน</h4>
        <Script>
                            $.getJSON('https://umbrellashareserver.herokuapp.com/month_expired', function(data) {
                    $('.demo3').append(data.length);
                });
        </Script>
        <table class="table3" style="border-collapse: collapse;">
            <tr>
                <th>ลำดับ</th>
                <th>รหัสผู้ยืม</th>
                <th>รหัสร่ม</th>
                <th>สถานที่ยืม</th>
                <th>วันที่ยืม</th>
                <th>วันกำหนดคืน</th>
                <th>วันที่่เกินกำหนด</th>
            </tr>
            <script>
                $.getJSON('https://umbrellashareserver.herokuapp.com/month_expired', function(data) {
                    var tr = data.report
                    for (var i = 0; i < data.length; i++) {
                        const b_day = new Date(parseInt(data[i].borrow_time));
                        b_day.toDateString();
                        const exp_day = new Date(parseInt(data[i].borrow_time));
                        exp_day.setDate(exp_day.getDate()+3);
                        // expired_date.toDateString();
                        const current_day = new Date();
                        const expired_day = Math.floor((current_day - parseInt(data[i].borrow_time))/(1000 * 60 * 60 * 24));
                        tr = $('<tr/>');
                        tr.append("<td>"+(i+1)+"</td>");
                        tr.append("<td>"+data[i].user_id+"</td>");
                        tr.append("<td>"+data[i].umbrella_id+"</td>");
                        tr.append("<td>"+data[i].borrow_place+"</td>");
                        tr.append("<td>"+b_day.toLocaleDateString()+"</td>");
                        tr.append("<td>"+exp_day.toLocaleDateString()+"</td>");
                        tr.append("<td>"+expired_day+"</td>");
                        $('.table3').append(tr);
                    }
                });
            </script>
        </table>
    </div>
    <div class="D_style">
        <h4>จำนวนการใช้บริการฝากร่ม ทั้งหมด  <b class="demo4"></b> ครั้ง</h4>
        <Script>
                            $.getJSON('https://umbrellashareserver.herokuapp.com/month_deposit', function(data) {
                    $('.demo4').append(data.length);
                });
        </Script>
        <table class="table4" style="border-collapse: collapse;">
            <tr>
                <th>ลำดับ</th>
                <th>รหัสผู้ฝาก</th>
                <th>ช่องที่ฝาก</th>
                <th>สถานที่ฝาก</th>
                <th>วันที่ฝาก</th>
                <th>สถานที่คืน</th>
                <th>วันที่คืน</th>
            </tr>
            <script>
                $.getJSON('https://umbrellashareserver.herokuapp.com/month_deposit', function(data) {
                    var tr = data.report
                    for (var i = 0; i < data.length; i++) {
                        const b_day = new Date(parseInt(data[i].deposit_time));
                        b_day.toDateString();
                        const g_day = new Date(parseInt(data[i].return_time));
                        g_day.toDateString();
                        tr = $('<tr/>');
                        tr.append("<td>"+(i+1)+"</td>");
                        tr.append("<td>"+data[i].user_id+"</td>");
                        tr.append("<td>"+data[i].locker+"</td>");
                        tr.append("<td>"+data[i].deposit_place+"</td>");
                        tr.append("<td>"+b_day.toLocaleDateString()+"</td>");
                        tr.append("<td>"+data[i].return_place+"</td>");
                        tr.append("<td>"+g_day.toLocaleDateString()+"</td>");
                        $('.table4').append(tr);
                    }
                });
            </script>
        </table>
    </div>
    <div class="D_style">
        <h4>จำนวนร่มที่ถูกฝากอยู่ ทั้งหมด  <b class="demo5"></b> คัน</h4>
        <Script>
                            $.getJSON('https://umbrellashareserver.herokuapp.com/month_depositing', function(data) {
                    $('.demo5').append(data.length);
                });
        </Script>
        <table class="table5" style="border-collapse: collapse;">
            <tr>
                <th>ลำดับ</th>
                <th>รหัสผู้ฝาก</th>
                <th>ช่องที่ฝาก</th>
                <th>สถานที่ฝาก</th>
                <th>วันที่ฝาก</th>
                <th>วันกำหนดรับคืน</th>
            </tr>
            <script>
                $.getJSON('https://umbrellashareserver.herokuapp.com/month_depositing', function(data) {
                    var tr = data.report
                    for (var i = 0; i < data.length; i++) {
                        const b_day = new Date(parseInt(data[i].deposit_time));
                        b_day.toDateString();
                        const exp_day = new Date(parseInt(data[i].deposit_time));
                        exp_day.setDate(exp_day.getDate()+3);
                        // expired_date.toDateString();
                        tr = $('<tr/>');
                        tr.append("<td>"+(i+1)+"</td>");
                        tr.append("<td>"+data[i].user_id+"</td>");
                        tr.append("<td>"+data[i].locker+"</td>");
                        tr.append("<td>"+data[i].deposit_place+"</td>");
                        tr.append("<td>"+b_day.toLocaleDateString()+"</td>");
                        tr.append("<td>"+exp_day+"</td>");
                        $('.table5').append(tr);
                    }
                });
            </script>
        </table>
    </div>
    <div class="D_style">
        <h4>จำนวนร่มที่ฝากเกินกำหนด ทั้งหมด  <b class="demo6"></b> คัน</h4>
        <Script>
                            $.getJSON('https://umbrellashareserver.herokuapp.com/deposit_expired', function(data) {
                    $('.demo6').append(data.length);
                });
        </Script>
        <table class="table6" style="border-collapse: collapse;">
            <tr>
                <th>ลำดับ</th>
                <th>รหัสผู้ฝาก</th>
                <th>ช่องที่ฝาก</th>
                <th>สถานที่ฝาก</th>
                <th>วันที่ฝาก</th>
                <th>วันกำหนดรับคืน</th>
                <th>วันที่่เกินกำหนด</th>
            </tr>
            <script>
                $.getJSON('https://umbrellashareserver.herokuapp.com/deposit_expired', function(data) {
                    var tr = data.report
                    for (var i = 0; i < data.length; i++) {
                        const b_day = new Date(parseInt(data[i].deposit_time));
                        b_day.toDateString();
                        const exp_day = new Date(parseInt(data[i].deposit_time));
                        exp_day.setDate(exp_day.getDate()+3);
                        // expired_date.toDateString();
                        const current_day = new Date();
                        const expired_day = Math.floor((current_day - parseInt(data[i].deposit_time))/(1000 * 60 * 60 * 24));
                        tr = $('<tr/>');
                        tr.append("<td>"+(i+1)+"</td>");
                        tr.append("<td>"+data[i].user_id+"</td>");
                        tr.append("<td>"+data[i].locker+"</td>");
                        tr.append("<td>"+data[i].deposit_place+"</td>");
                        tr.append("<td>"+b_day.toLocaleDateString()+"</td>");
                        tr.append("<td>"+exp_day.toLocaleDateString()+"</td>");
                        tr.append("<td>"+expired_day+"</td>");
                        $('.table6').append(tr);
                    }
                });
            </script>
        </table>
    </div>
</body>
</html>

<script>
    function Convert_HTML_To_PDF() {
  var elementHTML = document.getElementById('contentToPrint');

  html2canvas(elementHTML, {
    useCORS: true,
    onrendered: function(canvas) {
      var pdf = new jsPDF('p', 'pt', 'letter');

      var pageHeight = 980;
      var pageWidth = 900;
      for (var i = 0; i <= elementHTML.clientHeight / pageHeight; i++) {
        var srcImg = canvas;
        var sX = 0;
        var sY = pageHeight * i; // start 1 pageHeight down for every new page
        var sWidth = pageWidth;
        var sHeight = pageHeight;
        var dX = 0;
        var dY = 0;
        var dWidth = pageWidth;
        var dHeight = pageHeight;

        window.onePageCanvas = document.createElement("canvas");
        onePageCanvas.setAttribute('width', pageWidth);
        onePageCanvas.setAttribute('height', pageHeight);
        var ctx = onePageCanvas.getContext('2d');
        ctx.drawImage(srcImg, sX, sY, sWidth, sHeight, dX, dY, dWidth, dHeight);

        var canvasDataURL = onePageCanvas.toDataURL("image/png", 1.0);
        var width = onePageCanvas.width;
        var height = onePageCanvas.clientHeight;

        if (i > 0) // if we're on anything other than the first page, add another page
          pdf.addPage(612, 864); // 8.5" x 12" in pts (inches*72)

        pdf.setPage(i + 1); // now we declare that we're working on that page
        pdf.addImage(canvasDataURL, 'PNG', 20, 40, (width * .62), (height * .62)); // add content to the page
      }
			
	  // Save the PDF
      pdf.save('document.pdf');
    }
  });
}
</script>